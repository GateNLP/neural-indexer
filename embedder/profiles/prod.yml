#================================================
# DO NOT MODIFY - AUTOMATICALLY GENERATED FILE
# 
# Generated by `compose_generator.py` with args:
#  --compose_name prod\
#  --gpu True\
#  --is_system True\
#  --network_name default\
#  --replicas 3
#================================================


services:
  embedder-rep-0:
    command:
    - executor
    - --name
    - embedder/rep-0
    - --replicas
    - '3'
    - --uses
    - config.yml
    - --gpus
    - device=${EXECUTOR_GPU}
    - --host
    - 0.0.0.0
    - --port
    - '8081'
    - --monitoring
    - --port-monitoring
    - '9090'
    - --uses-metas
    - '{}'
    - --uses-with
    - '{"pretrained_model_name_or_path": "sentence-transformers/distiluse-base-multilingual-cased-v2",
      "device": "cuda"}'
    - --native
    deploy:
      resources:
        reservations:
          devices:
          - capabilities:
            - gpu
            device_ids:
            - ${EXECUTOR_GPU}
            driver: nvidia
    entrypoint:
    - jina
    environment:
    - JINA_LOG_LEVEL=INFO
    expose:
    - 9090
    healthcheck:
      interval: 10s
      retries: 60
      test: jina ping executor 127.0.0.1:8081
    image: ghcr.io/freddyheppell/transformer-torch-encoder-cu113:latest-gpu
    networks:
    - default
    volumes: &id001
    - huggingface:/root/.cache/huggingface
  embedder-rep-1:
    command:
    - executor
    - --name
    - embedder/rep-1
    - --replicas
    - '3'
    - --uses
    - config.yml
    - --gpus
    - device=${EXECUTOR_GPU}
    - --host
    - 0.0.0.0
    - --port
    - '8081'
    - --monitoring
    - --port-monitoring
    - '9090'
    - --uses-metas
    - '{}'
    - --uses-with
    - '{"pretrained_model_name_or_path": "sentence-transformers/distiluse-base-multilingual-cased-v2",
      "device": "cuda"}'
    - --native
    deploy:
      resources:
        reservations:
          devices:
          - capabilities:
            - gpu
            device_ids:
            - ${EXECUTOR_GPU}
            driver: nvidia
    entrypoint:
    - jina
    environment:
    - JINA_LOG_LEVEL=INFO
    expose:
    - 9090
    healthcheck:
      interval: 10s
      retries: 60
      test: jina ping executor 127.0.0.1:8081
    image: ghcr.io/freddyheppell/transformer-torch-encoder-cu113:latest-gpu
    networks:
    - default
    volumes: *id001
  embedder-rep-2:
    command:
    - executor
    - --name
    - embedder/rep-2
    - --replicas
    - '3'
    - --uses
    - config.yml
    - --gpus
    - device=${EXECUTOR_GPU}
    - --host
    - 0.0.0.0
    - --port
    - '8081'
    - --monitoring
    - --port-monitoring
    - '9090'
    - --uses-metas
    - '{}'
    - --uses-with
    - '{"pretrained_model_name_or_path": "sentence-transformers/distiluse-base-multilingual-cased-v2",
      "device": "cuda"}'
    - --native
    deploy:
      resources:
        reservations:
          devices:
          - capabilities:
            - gpu
            device_ids:
            - ${EXECUTOR_GPU}
            driver: nvidia
    entrypoint:
    - jina
    environment:
    - JINA_LOG_LEVEL=INFO
    expose:
    - 9090
    healthcheck:
      interval: 10s
      retries: 60
      test: jina ping executor 127.0.0.1:8081
    image: ghcr.io/freddyheppell/transformer-torch-encoder-cu113:latest-gpu
    networks:
    - default
    volumes: *id001
  gateway:
    command:
    - gateway
    - --title
    - Tweet Ingest Embedder
    - --description
    - Embeds documents with sentence-transformers/distiluse-base-multilingual-cased-v2
    - --cors
    - --no-crud-endpoints
    - --expose-endpoints
    - '{"/embed": {"summary": "Embed a document"}}'
    - --uses
    - HTTPGateway
    - --graph-description
    - '{"embedder": ["end-gateway"], "start-gateway": ["embedder"]}'
    - --deployments-addresses
    - '{"embedder": ["embedder-rep-0:8081", "embedder-rep-1:8081", "embedder-rep-2:8081"]}'
    - --port
    - '52592'
    - --protocol
    - HTTP
    - --monitoring
    - --port-monitoring
    - '9090'
    entrypoint:
    - jina
    environment:
    - JINA_LOG_LEVEL=INFO
    expose:
    - 52592
    - 9090
    healthcheck:
      interval: 2s
      test: jina ping gateway http://127.0.0.1:52592
    image: jinaai/jina:3.15.4-py38-standard
    networks:
    - default
    ports:
    - 52592:52592
  logstashembed:
    environment:
    - POOL_MAX=3
  metricbeat:
    environment:
    - JINA_HOSTS=[http://embedder-rep-0:9090, http://embedder-rep-1:9090, http://embedder-rep-2:9090,
      http://gateway:9090]
volumes:
  huggingface:
    driver: local
